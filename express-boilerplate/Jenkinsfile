node {
    checkout([$class: 'GitSCM', branches: [[name: "${BRANCH_NAME}"]], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'PathRestriction', excludedRegions: '', includedRegions: 'express-boilerplate/.*'], [$class: 'PruneStaleBranch'], [$class: 'CloneOption', depth: 0, noTags: false, reference: "${JENKINS_HOME}/repos/playground-projects", shallow: false]], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/Mksony/playground-projects.git']]])

    docker.image('node:8.5.0').inside('--user node') {
        withEnv([
        /* Override the npm cache directory to avoid: EACCES: permission denied, mkdir '/.npm' */
        'npm_config_cache=npm-cache',
        /* set home to our current directory because other bower
        * nonsense breaks with HOME=/, e.g.:
        * EACCES: permission denied, mkdir '/.config'
        */
        'HOME=.',
        'CI=true'
        ]) {

            stage('Install dependencies') {
                sh 'cd express-boilerplate && yarn'
            }

            stage('Run tests') {
                sh 'cd express-boilerplate && yarn test:ci'
                stash includes: 'express-boilerplate/junit.xml', name: 'testResults'
            }

        }
    }
    stage('Publish test results') {
        unstash 'testResults'
        junit 'express-boilerplate/junit.xml'
    }
}
